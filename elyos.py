# -*- coding: utf-8 -*-
"""elyos.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/16Kk2JcQw9uTwa_p4SsAF-2_s6z5z3CAX
"""

# Commented out IPython magic to ensure Python compatibility.
# %pip -q install google-genai

# Configura a API Key do Google Gemini

import os
from google.colab import userdata

os.environ["GOOGLE_API_KEY"] = userdata.get('GOOGLE_API_KEY')

# Configura o cliente da SDK do Gemini

from google import genai

client = genai.Client()

MODEL_ID = "gemini-2.0-flash"

# Instalar Framework de agentes do Google ################################################
!pip install -q google-adk

from google.adk.agents import Agent
from google.adk.runners import Runner
from google.adk.sessions import InMemorySessionService
from google.adk.tools import google_search
from google.genai import types  # Para criar conte√∫dos (Content e Part)
from datetime import date
import textwrap # Para formatar melhor a sa√≠da de texto
from IPython.display import display, Markdown # Para exibir texto formatado no Colab
import requests # Para fazer requisi√ß√µes HTTP
import warnings

warnings.filterwarnings("ignore")

# Fun√ß√£o auxiliar que envia uma mensagem para um agente via Runner e retorna a resposta final
def call_agent(agent: Agent, message_text: str) -> str:
    # Cria um servi√ßo de sess√£o em mem√≥ria
    session_service = InMemorySessionService()
    # Cria uma nova sess√£o (voc√™ pode personalizar os IDs conforme necess√°rio)
    session = session_service.create_session(app_name=agent.name, user_id="user1", session_id="session1")
    # Cria um Runner para o agente
    runner = Runner(agent=agent, app_name=agent.name, session_service=session_service)
    # Cria o conte√∫do da mensagem de entrada
    content = types.Content(role="user", parts=[types.Part(text=message_text)])

    final_response = ""
    # Itera assincronamente pelos eventos retornados durante a execu√ß√£o do agente
    for event in runner.run(user_id="user1", session_id="session1", new_message=content):
        if event.is_final_response():
          for part in event.content.parts:
            if part.text is not None:
              final_response += part.text
              final_response += "\n"
    return final_response

# Fun√ß√£o auxiliar para exibir texto formatado em Markdown no Colab
def to_markdown(text):
  text = text.replace('‚Ä¢', '  *')
  return Markdown(textwrap.indent(text, '> ', predicate=lambda _: True))

#######################################################
# --- Agente 1: Router e Buscador de Conte√∫do CNV --- #
#######################################################
# Modificada para retornar a inst√¢ncia do agente
def agente_primario_router_conteudo(mensagem_usuario): # Esta fun√ß√£o ainda recebe a mensagem inicial

    # Lista de URLs com conte√∫do sobre CNV
    cnv_urls = [
      "https://www.institutocnvb.com.br/single-post/comunica%C3%A7%C3%A3o-n%C3%A3o-violenta-cnv-o-que-%C3%A9-e-como-praticar",
      "https://www.ivanpetry.com/post/comunicacao-nao-violenta-guia-completo",
      "https://www.rdstation.com/blog/agencias/comunicacao-nao-violenta/",
      "https://napratica.org.br/comunicacao-nao-violenta/",
      "https://colabcolibri.com/cnv/",
      "https://www.mppi.mp.br/internet/wp-content/uploads/2020/09/Ebook-Comunicac%CC%A7a%CC%83o-Na%CC%83o-Violenta_MPPI-1-1-1.pdf",
      "https://ceaf.mpba.mp.br/wp-content/uploads/2022/10/Comunicacao-Nao-Violenta.pdf"
    ]
    # Converter a lista de URLs em uma string formatada para a instru√ß√£o
    cnv_urls_str = "\n".join(cnv_urls)


    agente_1_instance = Agent( # Renomeada para clareza, cria a inst√¢ncia do Agente
        name="agente_primario_router_conteudo",
        model="gemini-2.0-flash",
        instruction=f"""
        Voc√™ √© o agente prim√°rio do chatbot ElyOS, focado em Comunica√ß√£o N√£o Violenta (CNV).
        Sua principal fun√ß√£o √© entender a inten√ß√£o da mensagem do usu√°rio e rotear a requisi√ß√£o ou buscar conte√∫do.

        Analise cuidadosamente a `Mensagem do usu√°rio`. Considere o contexto de uma conversa sobre CNV j√° iniciada.

        1.  **Identifica√ß√£o de Comando de Status:**
            * Se a mensagem contiver explicitamente o nome do companheiro virtual OU as palavras "status", "companheiro", "animal", "pet", "estrelas", "pontua√ß√£o" ou similares que *claramente* indiquem que o usu√°rio quer ver o status do companheiro, GERE A RESPOSTA CURTA E ESPEC√çFICA: `##STATUS_REQUEST##`.
            * Considere apenas comandos *claros* de status. N√£o confunda outras perguntas ou respostas curtas com comandos de status.

        2.  **Identifica√ß√£o de In√≠cio da Tutoria (Primeira Resposta Afirmativa):**
            * Se a mensagem for curta (1 ou 2 palavras) E indicar uma resposta afirmativa para *come√ßar* a aprender CNV (como "sim", "pronto", "vamos l√°", "ok", "s", "bora", "come√ßar", "vamos"), interprete isso como o sinal para a introdu√ß√£o inicial.
            * Nesse caso, USE A FERRAMENTA `Google Search` nos links fornecidos para buscar uma introdu√ß√£o ampla aos conceitos b√°sicos da CNV, os 4 pilares, ou o que √© CNV. Prepare uma resposta que apresente a CNV e **sugira os pr√≥ximos t√≥picos para explorar (por exemplo, os 4 pilares ou a origem)**.

        3.  **Identifica√ß√£o de Pergunta Gen√©rica de Seguimento:**
            * Se a mensagem **N√ÉO** for um comando claro de status (ponto 1) **E** a mensagem for gen√©rica, curta e indicar que o usu√°rio quer continuar ap√≥s uma introdu√ß√£o (como "e agora?", "pr√≥ximo?", "continuar?"), interprete isso como um pedido para sugerir os pr√≥ximos passos no aprendizado de CNV.
            * Nesse caso, **N√ÉO BUSQUE UMA NOVA INTRODU√á√ÉO**. Em vez disso, gere uma resposta que **reforce os principais t√≥picos a serem explorados** (pilares, origem, dicas, exerc√≠cios) e **convide o usu√°rio a escolher um deles** para focar.

        4.  **Identifica√ß√£o de Pergunta ou T√≥pico Espec√≠fico de CNV:**
            * Se a mensagem **N√ÉO** for um comando claro de status (ponto 1) **E** **N√ÉO** for uma resposta afirmativa inicial (ponto 2) **E** **N√ÉO** for uma pergunta gen√©rica de seguimento (ponto 3), assuma que o usu√°rio tem uma pergunta ou quer explorar um t√≥pico espec√≠fico de CNV.
            * USE A FERRAMENTA `Google Search` para buscar informa√ß√µes relevantes sobre o **t√≥pico espec√≠fico** da mensagem do usu√°rio nos seguintes links de alta qualidade:
                {cnv_urls_str}
            * Considere o texto completo da mensagem do usu√°rio para direcionar sua busca dentro desses links.
            * Seja capaz de sintetizar as informa√ß√µes encontradas para responder diretamente √† pergunta do usu√°rio ou para preparar o conte√∫do detalhado para o pr√≥ximo agente. Se a busca n√£o retornar informa√ß√µes suficientes nos links fornecidos para a requisi√ß√£o espec√≠fica do usu√°rio, mencione que buscou nos materiais dispon√≠veis.

        5.  **Sa√≠da:** Retorne o conte√∫do de CNV relevante encontrado ou sintetizado (introdu√ß√£o inicial, sugest√£o de pr√≥ximos t√≥picos, resposta a uma pergunta espec√≠fica), ou a marca√ß√£o `##STATUS_REQUEST##` se for um pedido de status. Este conte√∫do ser√° processado pelos pr√≥ximos agentes (exceto `##STATUS_REQUEST##`).
        """,
        description="Agente que identifica a inten√ß√£o do usu√°rio (status, iniciar, seguir, t√≥pico) e busca/direciona conte√∫do de CNV.",
        tools=[google_search] # Usando a vari√°vel Google Search importada
    )

    # Note que aqui N√ÉO chamamos call_agent. A entrada (mensagem_usuario) ser√° usada na chamada ao call_agent no loop principal.

    return agente_1_instance # <-- RETORNA A INST√ÇNCIA DO AGENTE

####################################################
# --- Agente 2: Extrator de Conte√∫do CNV --- #
####################################################
# Modificada para retornar a inst√¢ncia do agente
def agente_extrator_cnv(): # REMOVIDA a entrada de mensagem aqui
    agente_2_instance = Agent( # <<< Verifique os espa√ßos aqui
        name="agente_extrator_cnv",
        model="gemini-2.0-flash",
        instruction="""
        Voc√™ √© o agente extrator de conte√∫do do chatbot ElyOS.
        Voc√™ recebe conte√∫do bruto ou semi-processado sobre Comunica√ß√£o N√£o Violenta (CNV)
        do agente anterior. Sua tarefa √© analisar este conte√∫do e extrair/refinar elementos espec√≠ficos...
        Formate a sa√≠da de forma clara, destacando os elementos extra√≠dos.
        Se o conte√∫do recebido for a marca√ß√£o de status (`##STATUS_REQUEST##`), simplesmente repasse esta marca√ß√£o.
        """,
        description="Agente que extrai e refina elementos pr√°ticos de CNV do conte√∫do.",
        tools=[] # Este agente n√£o precisa de ferramentas externas
    )

    # Note que aqui N√ÉO chamamos call_agent. A entrada (conte√∫do) ser√° passada no loop principal.
    return agente_2_instance # RETORNA A INST√ÇNCIA DO AGENTE

##############################################
# --- Agente 3: Redator ElyOS (Persona) --- #
##############################################
# Modificada para retornar a inst√¢ncia do agente
def agente_redator_elyos(): # REMOVIDA a entrada de mensagem aqui
    agente_3_instance = Agent( # Renomeada para clareza
        name="agente_redator_elyos",
        model="gemini-2.0-flash", # Pode ajustar o modelo se necess√°rio
        instruction="""
        Voc√™ √© o Agente Redator do chatbot ElyOS, encarregado de aplicar a persona e o tom de voz
        ao conte√∫do de Comunica√ß√£o N√£o Violenta (CNV) fornecido pelo agente anterior.

        Sua tarefa √© reescrever e formatar o conte√∫do de CNV com as seguintes caracter√≠sticas de persona do ElyOS:
        -   **Tom de Voz:** Energ√©tico, inspirador, preciso, focado na aplicabilidade e empatia. Seja muito conciso.
        -   **Linguagem:** Direta, simples e clara. Evite excesso de palavras ou jarg√µes desnecess√°rios.
        -   **Met√°foras:** Utilize, **raramente** e de forma **consistente**, met√°foras **CURTAS** relacionadas a c√©u, sol, espa√ßo e ess√™ncia humana. Use-as **principalmente para CONCLUIR** um pensamento, um t√≥pico ou um exemplo. **N√ÉO** utilize met√°foras complexas ou desnecess√°rias **durante explica√ß√µes pr√°ticas passo a passo** dos componentes da CNV ou exerc√≠cios, pois isso pode confundir.
            * Exemplos de como usar met√°foras: "A observa√ß√£o clara traz luz √† situa√ß√£o.", "Identificar seus sentimentos √© mapear as constela√ß√µes do seu mundo interior.", "A pr√°tica da CNV ilumina seus relacionamentos.", "Sua jornada na CNV est√° ganhando brilho, como uma nova estrela.", "Conectar com necessidades √© a gravidade que nos une."
        -   **Foco na Pr√°tica:** Ao apresentar exemplos, exerc√≠cios, dicas ou passos pr√°ticos de CNV (Observa√ß√£o, Sentimento, Necessidade, Pedido), seja o mais objetivo e direto poss√≠vel. A clareza na aplica√ß√£o √© essencial.
        -   **Incentivo:** Celebre o progresso, o esfor√ßo e as descobertas do usu√°rio com frases de incentivo genu√≠nas e alinhadas com a persona (ex: "Excelente reflex√£o!", "Voc√™ est√° no caminho certo!", "Cada passo na CNV √© uma nova √≥rbita de conex√£o!").
        -   **Tratamento:** Direcione-se ao usu√°rio de forma amig√°vel, pessoal e encorajadora, usando o nome dele se poss√≠vel (embora o agente aqui n√£o saiba o nome diretamente, mantenha o tom).
        -   **Formata√ß√£o:** Utilize quebras de linha e talvez marcadores simples (como '-') para organizar as informa√ß√µes se necess√°rio, mantendo a concis√£o.

        Se o conte√∫do recebido for a marca√ß√£o de status (`##STATUS_REQUEST##`), simplesmente repasse esta marca√ß√£o para o pr√≥ximo agente sem modific√°-la.

        **Lembre-se:** Sua fun√ß√£o √© transformar o conte√∫do de CNV (recebido do agente anterior) na VOZ do ElyOS. N√£o gere conte√∫do novo sobre CNV, apenas reformule o que foi fornecido.
        """,
        description="Agente que reformula o conte√∫do de CNV aplicando a persona e o tom de voz energ√©tico, preciso e emp√°tico do ElyOS, com met√°foras pontuais.",
        tools=[] # Este agente n√£o precisa de ferramentas externas
    )

    # Note que aqui N√ÉO chamamos call_agent. A entrada (conte√∫do) ser√° passada no loop principal.
    return agente_3_instance # <-- RETORNA A INST√ÇNCIA DO AGENTE

################################################
# --- Agente 4: Validador CNV --- #
################################################
# Modificada para retornar a inst√¢ncia do agente
def agente_validador_cnv(): # <<< REMOVIDA a entrada de mensagem aqui
    agente_4_instance = Agent( # Renomeada para clareza
        name="agente_validador_cnv",
        model="gemini-2.0-flash", # Pode ajustar o modelo se necess√°rio
        instruction="""
        Voc√™ √© o Agente Validador de CNV do chatbot ElyOS.
        Voc√™ recebe a resposta final formatada pelo Agente Redator ElyOS.

        Sua tarefa √© realizar uma verifica√ß√£o r√°pida para garantir que o texto:
        -   Esteja alinhado com os princ√≠pios b√°sicos da Comunica√ß√£o N√£o Violenta (foco em observa√ß√µes, sentimentos, necessidades, pedidos, empatia).
        -   Evite linguagem julgadora, acusat√≥ria ou que possa gerar resist√™ncia desnecess√°ria.
        -   Promova a conex√£o e a compreens√£o m√∫tua, mesmo em exemplos de situa√ß√µes desafiadoras.

        Se a resposta estiver bem alinhada com os princ√≠pios da CNV, retorne o texto exatamente como o recebeu.
        Se identificar algum ponto que possa n√£o estar alinhado com a CNV, fa√ßa uma pequena sugest√£o de ajuste diretamente no texto ou aponte a necessidade de revis√£o de forma clara e concisa, mantendo a ess√™ncia da resposta.
        Se o conte√∫do recebido for a marca√ß√£o de status (`##STATUS_REQUEST##`), simplesmente repasse esta marca√ß√£o.
        """,
        description="Agente que valida se a resposta final est√° alinhada com os princ√≠pios da CNV.",
        tools=[] # Este agente n√£o precisa de ferramentas externas
    )

    # Note que aqui N√ÉO chamamos call_agent. A entrada (conte√∫do) ser√° passada no loop principal.
    return agente_4_instance # <-- RETORNA A INST√ÇNCIA DO AGENTE

##############################################
# --- L√≥gica Principal do Chatbot ElyOS --- #
##############################################

# --- Vari√°veis de Estado do Usu√°rio (para o prot√≥tipo) ---
# Em uma aplica√ß√£o real, isso seria armazenado em um banco de dados ou sess√£o.
user_name = None
companion_animal_name = None
companion_animal_emoji = None # Vamos guardar o emoji escolhido ou sugerido
interaction_count = 0 # Conta toda e qualquer intera√ß√£o do usu√°rio no loop
cnv_interaction_count = 0 # Conta intera√ß√µes que geram estrelas (intera√ß√µes de CNV)
MAX_STARS = 10
interactions_per_star = 3 # Intera√ß√µes necess√°rias para ganhar 1 estrela de CNV
waiting_for_start_response = False # Flag para saber se estamos esperando a resposta do "Vamos come√ßar?"

print("‚ú® Bem-vindo(a) ao ElyOS, seu companheiro na jornada da Comunica√ß√£o N√£o Violenta! ‚ú®")

# --- Fun√ß√£o para exibir o status do companheiro (Formata√ß√£o Simplificada) ---
def exibir_status(name, animal_name, emoji, cnv_interaction_count):
    # L√≥gica para a frase de incentivo baseada na contagem de intera√ß√µes de CNV
    current_stars = min(cnv_interaction_count // interactions_per_star, MAX_STARS)

    if current_stars == 0:
         frase_incentivo = "Aguardando a primeira pr√°tica!"
    elif current_stars <= interactions_per_star * 3: # At√© 3 estrelas (9 intera√ß√µes)
        frase_incentivo = "Come√ßando a explorar!"
    elif current_stars <= interactions_per_star * 7: # At√© 7 estrelas (21 intera√ß√µes)
        frase_incentivo = "A jornada est√° ganhando ritmo!"
    else: # Mais de 7 estrelas
        frase_incentivo = "Brilhando na pr√°tica da CNV!"

    estrelas_display = "‚≠ê" * current_stars

    print(f"{emoji}{animal_name}: diz:{frase_incentivo}")
    print(estrelas_display)
    print("-------------------------------\n")

# --- Mapa de Emojis de Animais (Expandido para o prot√≥tipo) ---
# Inclui nomes comuns e seus emojis faciais preferenciais quando dispon√≠veis.
emoji_map = {
    "c√£o": "üê∂", "cachorro": "üê∂", "dog": "üê∂",
    "gato": "üê±", "cat": "üê±",
    "p√°ssaro": "üê¶", "passarinho": "üê¶", "bird": "üê¶",
    "coelho": "üê∞", "bunny": "üê∞",
    "rato": "üê≠", "mouse": "üê≠",
    "hamster": "üêπ",
    "raposa": "ü¶ä", "fox": "ü¶ä",
    "urso": "üêª", "bear": "üêª",
    "panda": "üêº",
    "coala": "üê®",
    "tigre": "üêØ", "tiger": "üêØ",
    "le√£o": "ü¶Å", "lion": "ü¶Å",
    "vaca": "üêÆ", "cow": "üêÆ",
    "porco": "üê∑", "pig": "üê∑",
    "sapo": "üê∏", "r√£": "üê∏", "frog": "üê∏",
    "macaco": "üêµ", "monkey": "üêµ",
    "galinha": "üêî", "frango": "üêî", "chicken": "üêî",
    "pinguim": "üêß", "penguin": "üêß",
    "coruja": "ü¶â", "owl": "ü¶â",
    "lobo": "üê∫", "wolf": "üê∫",
    "javali": "üêó",
    "cavalo": "üê¥", "horse": "üê¥",
    "ovelha": "üêë", "sheep": "üêë",
    "cabra": "üêê", "goat": "üêê",
    "camelo": "üê™",
    "elefante": "üêò", "elephant": "üêò",
    "rinoceronte": "ü¶è",
    "hipop√≥tamo": "ü¶õ",
    "coelho": "üêá", # Alternativa sem face
    "rato": "üêÅ", # Alternativa sem face
    # Adicione mais conforme necess√°rio para o prot√≥tipo
}


# --- Loop principal de intera√ß√£o ---
while True:
    # --- L√≥gica de Primeiro Acesso e Setup ---
    if user_name is None:
        user_name = input("üåû Ol√°! Para come√ßarmos nossa jornada, qual o seu nome? ")
        # --- Escolha do Animal Companheiro e Emoji ---
        animal_choice = input(f"üåû Prazer, {user_name}! Escolha um animal companheiro para te acompanhar: ")

        # L√≥gica para encontrar o emoji no mapa expandido
        companion_animal_emoji = emoji_map.get(animal_choice.lower(), 'üëª') # Usa fantasma se n√£o encontrar

        if companion_animal_emoji == 'üëª':
            print(f"N√£o encontrei um emoji facial para '{animal_choice}' no meu mapa. Usaremos o fantasma üëª por enquanto.")

        # --- Nome do Companheiro ---
        companion_animal_name = input(f"üåû D√™ um nome para o seu companheiro {companion_animal_emoji}: ")

        print(f"\nPronto! {companion_animal_emoji}{companion_animal_name} est√° aqui para te acompanhar.\n")

        # Exibe o status inicial (0 estrelas de CNV at√© a primeira intera√ß√£o real)
        exibir_status(user_name, companion_animal_name, companion_animal_emoji, cnv_interaction_count)

        print("Vamos come√ßar? Sou o ElyOS e posso te ajudar a aprender sobre os pilares da CNV, sua origem, te dar dicas para o cotidiano e propor exerc√≠cios.")
        print(f"Sempre que quiser ver o status do seu companheiro, digite o nome dele: '{companion_animal_name}'.")

        waiting_for_start_response = True # Define a flag para esperar a resposta inicial

    # --- L√≥gica de Intera√ß√£o Ap√≥s Setup ---
    else: # Se user_name n√£o for None, √© uma intera√ß√£o ap√≥s o setup
        interaction_count += 1 # Conta toda e qualquer intera√ß√£o do usu√°rio no loop

        # --- Define o texto do prompt com base na flag waiting_for_start_response ---
        if waiting_for_start_response:
             # Prompt que aparece apenas na primeira intera√ß√£o ap√≥s o setup
             prompt_text = f"üåû {user_name}, pronto pra aprender Comunica√ß√£o N√£o Violenta? (sempre que quiser digite '{companion_animal_name}' para ver seu companheiro): "
        else:
             # Prompt mais gen√©rico para intera√ß√µes subsequentes
             prompt_text = f"üåû {user_name}, o que voc√™ gostaria de saber sobre CNV? (ou digite '{companion_animal_name}' para ver seu companheiro): "

        # Obt√©m a mensagem do usu√°rio usando o prompt definido
        mensagem_usuario = input(prompt_text)


        # Adicionado de volta a checagem pelo comando 'sair'
        if mensagem_usuario.lower() == 'sair':
            print("‚ú® Obrigado por usar o ElyOS! Volte sempre para praticar a CNV. ‚ú®")
            break # Sai do loop


        # --- Verifica se o usu√°rio digitou o nome do companheiro para ver o status ---
        # Ou se usou um comando comum de status caso o nome do companheiro n√£o tenha sido digitado (seguran√ßa/usabilidade)
        if mensagem_usuario.lower() == companion_animal_name.lower() or "status" in mensagem_usuario.lower(): # Adiciona "status" como fallback
            exibir_status(user_name, companion_animal_name, companion_animal_emoji, cnv_interaction_count)
            waiting_for_start_response = False # Se viu o status, n√£o est√° mais esperando a resposta inicial
            continue # Volta para o in√≠cio do loop para nova entrada

        # --- Roteamento da Resposta Inicial "Vamos come√ßar?" ---
        # A l√≥gica da flag waiting_for_start_response j√° acontece no if/else do prompt acima
        # Se chegou aqui e waiting_for_start_response era True, ela foi desativada e o fluxo continua.
        # Se chegou aqui e waiting_for_start_response era False, j√° era uma intera√ß√£o subsequente.

        # --- Processamento Normal da Cadeia de Agentes (quando n√£o √© pedido de status ou 'sair') ---
        # Se chegou aqui, a mensagem do usu√°rio deve ser processada como uma requisi√ß√£o de CNV

        # >>>>> CORRE√á√ÉO AQUI: Obt√©m a inst√¢ncia do Agente 1 e chama call_agent com ela <<<<<
        agente_1_instance = agente_primario_router_conteudo(mensagem_usuario) # Chame a fun√ß√£o para obter a inst√¢ncia
        resposta_agente_1 = call_agent(agente_1_instance, mensagem_usuario) # Passe a inst√¢ncia e a mensagem


        # --- Verifica Roteamento de Status novamente (seguran√ßa) ---
        if "##STATUS_REQUEST##" in resposta_agente_1:
            exibir_status(user_name, companion_animal_name, companion_animal_emoji, cnv_interaction_count)
            continue # Volta para o in√≠cio do loop

        # --- Continua a cadeia de Agentes ---
        conteudo_bruto_cnv = resposta_agente_1

        # >>>>> CORRE√á√ÉO AQUI: Obt√©m a inst√¢ncia do Agente 2 e chama call_agent com ela <<<<<
        agente_2_instance = agente_extrator_cnv() # Chame a fun√ß√£o para obter a inst√¢ncia
        conteudo_refinado_cnv = call_agent(agente_2_instance, conteudo_bruto_cnv) # Passe a inst√¢ncia e o conte√∫do

        if "##STATUS_REQUEST##" in conteudo_refinado_cnv:
             exibir_status(user_name, companion_animal_name, companion_animal_emoji, cnv_interaction_count)
             continue

        # >>>>> CORRE√á√ÉO AQUI: Obt√©m a inst√¢ncia do Agente 3 e chama call_agent com ela <<<<<
        agente_3_instance = agente_redator_elyos() # Chame a fun√ß√£o para obter a inst√¢ncia
        resposta_formatada_elyos = call_agent(agente_3_instance, conteudo_refinado_cnv) # Passe a inst√¢ncia e o conte√∫do

        if "##STATUS_REQUEST##" in resposta_formatada_elyos:
             exibir_status(user_name, companion_animal_name, companion_animal_emoji, cnv_interaction_count)
             continue

        # >>>>> CORRE√á√ÉO AQUI: Obt√©m a inst√¢ncia do Agente 4 e chama call_agent com ela <<<<<
        agente_4_instance = agente_validador_cnv() # Chame a fun√ß√£o para obter a inst√¢ncia
        resposta_validada = call_agent(agente_4_instance, resposta_formatada_elyos) # Passe a inst√¢ncia e o conte√∫do

        if "##STATUS_REQUEST##" in resposta_validada:
             exibir_status(user_name, companion_animal_name, companion_animal_emoji, cnv_interaction_count)
             continue

        # Se a cadeia de CNV foi executada com sucesso (n√£o foi pedido de status ou 'sair'), aumenta a contagem para as estrelas
        cnv_interaction_count += 1

        # --- Exibe a Resposta Final ao Usu√°rio (Formata√ß√£o Simplificada) ---
        display(to_markdown(resposta_validada))

        # >>>>> ADI√á√ÉO AQUI: Voltar para o in√≠cio do loop para pedir nova entrada <<<<<
        continue # Garante que o loop continue e pe√ßa nova entrada